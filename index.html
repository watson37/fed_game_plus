<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fed Game Plus - Policy Simulator</title>
  <style>
    :root{--bg:#0b1020;--card:#111a33;--ink:#eaf0ff;--muted:#a9b6da;--line:#24335d;--good:#35d07f;--warn:#ffd166;--bad:#ff5c7a;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:linear-gradient(180deg,var(--bg),#070a14)}
    header{padding:18px 18px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px 22px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(17,26,51,.88);border:1px solid rgba(255,255,255,.08);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:14px;margin:0 0 10px;color:var(--ink)}
    .card .pad{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{flex:1;min-width:150px;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;background:rgba(0,0,0,.10)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;margin-top:4px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
    label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
    input[type=range]{width:100%}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{appearance:none;border:1px solid rgba(255,255,255,.14);background:#1a2650;color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:650;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    button.primary{background:#2a3c7a;border-color:rgba(255,255,255,.2)}
    button.danger{background:#4a1e2a}
    button:disabled{opacity:.5;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    canvas{width:100%;height:420px;display:block}
    .log{max-height:220px;overflow:auto;border-top:1px solid rgba(255,255,255,.08);padding:10px 14px;color:var(--muted);font-size:12px;line-height:1.35}
    .log b{color:var(--ink)}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){.twoCol{grid-template-columns:1fr}}
    textarea{width:100%;min-height:120px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:var(--ink);padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px}

    /* Tooltips */
    .tipwrap{display:inline-flex;align-items:center;gap:6px}
    .tip{position:relative;display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:rgba(255,255,255,.75);font-size:12px;cursor:help;user-select:none;background:rgba(0,0,0,.16)}
    .tip:focus{outline:2px solid rgba(255,255,255,.18);outline-offset:2px}
    .tip[data-tip]::after{
      content:attr(data-tip);
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(100% + 10px);
      width:min(330px, 74vw);
      background:rgba(10,14,30,.96);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 10px;
      border-radius:12px;
      color:rgba(255,255,255,.88);
      font-size:12px;
      line-height:1.35;
      box-shadow:0 14px 30px rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition:opacity .12s ease;
      z-index:50;
      white-space:pre-wrap;
    }
    .tip[data-tip]::before{
      content:"";
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(100% + 4px);
      width:10px;height:10px;
      background:rgba(10,14,30,.96);
      border-left:1px solid rgba(255,255,255,.12);
      border-top:1px solid rgba(255,255,255,.12);
      transform:translateX(-50%) rotate(45deg);
      opacity:0;
      transition:opacity .12s ease;
      z-index:51;
    }
    .tip:hover::after,.tip:hover::before,.tip:focus::after,.tip:focus::before{opacity:1}

    /* Credibility meter */
    .meter{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid rgba(255,255,255,.10);margin-top:8px}
    .meter > span{display:block;height:100%;width:0%;background:linear-gradient(90deg, var(--bad), var(--warn), var(--good));}

    /* News card */
    .news{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12);border-radius:12px;padding:10px;margin-top:12px}
    .newsTop{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .headline{font-weight:750;color:rgba(255,255,255,.92);font-size:13px;line-height:1.25}
    .deck{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}

    .controlsMini{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.20);color:var(--ink);padding:6px 8px;font-size:12px}
    .toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .toggle input{width:16px;height:16px}

    .hintBox{margin-top:8px;border-top:1px solid rgba(255,255,255,.10);padding-top:8px;color:rgba(255,255,255,.85);font-size:12px;line-height:1.35}
    .hintBox b{color:rgba(255,255,255,.92)}

    .hint{margin-top:10px}
  </style>
</head>
<body>
<header>
  <h1>Fed Game Plus - Monetary Policy Simulator</h1>
  <p class="sub">You’re the FOMC. Each quarter you set the policy rate, tweak QE/QT, and choose guidance. The economy responds with lags, expectations, and shocks. Try to keep inflation near target and unemployment near NAIRU without whipping the economy around.</p>
</header>

<div class="wrap">
  <div class="grid">

    <div class="card">
      <div class="pad">
        <h2>Controls</h2>

        <div class="row">
          <div class="kpi">
            <div class="label">Quarter</div>
            <div class="val"><span id="qtr">1</span> / <span id="qtrMax">12</span></div>
          </div>
          <div class="kpi">
            <div class="label">
              <span class="tipwrap">Score
                <span class="tip" tabindex="0" data-tip="Score adds up each quarter.
Max possible per quarter is 120 points.
The grade is based on your score divided by the max points you could have earned so far.

If the grade says Oops, Recession, it usually means inflation or unemployment is far from target, or your policy swings are too big."></span>
              </span>
            </div>
            <div class="val">
              <span id="score">0</span> / <span id="scoreMax">120</span>
              <span class="tag" id="scorePct">0%</span>
              <span class="tag" id="grade">—</span>
            </div>
          </div>
        </div>

        <label>
          <span class="tipwrap">Policy rate (i)
            <span class="tip" tabindex="0" data-tip="Interest rate = the big steering wheel.

Raise i to cool demand and reduce inflation (with a lag), but unemployment can rise.
Lower i to boost demand and jobs (with a lag), but inflation can rise.

Tip: big jumps earn volatility penalties. Steady moves often win."></span>
          </span>
          <span class="tag" id="iTag">2.50%</span>
        </label>
        <input id="iRate" type="range" min="0" max="8" step="0.25" value="2.5" />

        <label>
          <span class="tipwrap">QE / QT (balance sheet impulse)
            <span class="tip" tabindex="0" data-tip="QE/QT is your secondary lever.

QE (positive) = easier financial conditions, boosts demand a bit.
QT (negative) = tighter conditions, cools demand a bit.

Use this to fine tune when you do not want huge rate moves."></span>
          </span>
          <span class="tag" id="qeTag">0</span>
        </label>
        <input id="qe" type="range" min="-3" max="3" step="0.25" value="0" />
        <div class="small">Negative = QT (tightening). Positive = QE (easing). It acts like a small additional push on demand.</div>

        <label>
          <span class="tipwrap">Forward guidance
            <span class="tip" tabindex="0" data-tip="Guidance is what you SAY.

Dovish guidance nudges expected future rates down.
Hawkish nudges expected future rates up.

But guidance only really moves expectations when credibility is high.
If you say hawkish and cut rates, credibility falls."></span>
          </span>
          <span class="tag" id="fgTag">Neutral</span>
        </label>
        <input id="fg" type="range" min="-2" max="2" step="1" value="0" />
        <div class="small">Dovish guidance lowers expected future rates. Hawkish does the opposite. This moves expectations right away, more when credibility is high.</div>

        <div class="news" aria-live="polite">
          <div class="newsTop">
            <div class="headline" id="headline">Breaking: —</div>
            <div class="controlsMini">
              <label class="toggle" title="Choose how explicit the headlines are">
                Difficulty
                <select id="difficulty">
                  <option value="mixed" selected>Mixed</option>
                  <option value="easy">Easy</option>
                  <option value="hard">Hard</option>
                </select>
              </label>
              <label class="toggle" title="Show a policy hint under the headline">
                <input id="hintToggle" type="checkbox" />
                Policy hint
              </label>
              <span class="tip" tabindex="0" data-tip="Difficulty controls how obvious the headline is.

Easy: labels the type of shock.
Hard: more interpretive, like real news.
Mixed: some obvious, some interpretive.

Policy hint: gives a suggested direction, not a guarantee."></span>
            </div>
          </div>
          <div class="deck" id="newsDeck">—</div>
          <div class="hintBox" id="policyHint" style="display:none"></div>
        </div>

        <div class="btnbar">
          <button class="primary" id="advance">Advance quarter</button>
          <button id="copy">Copy summary text</button>
          <button class="danger" id="reset">Reset run</button>
        </div>

        <div class="hint small">
          <b>Targets:</b> Inflation 2.0%, Unemployment 4.5% (NAIRU).<br/>
          <b>Tip:</b> Big policy moves raise volatility penalties. Small, steady adjustments usually win.
        </div>
      </div>

      <div class="log" id="log"></div>

    </div>

    <div class="card">
      <div class="pad">
        <h2>Dashboard</h2>
        <div class="row" style="margin-bottom:12px">
          <div class="kpi">
            <div class="label">Inflation (π)</div>
            <div class="val"><span id="pi">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Unemployment (u)</div>
            <div class="val"><span id="u">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Output gap (y)</div>
            <div class="val"><span id="y">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Expected inflation (Eπ)</div>
            <div class="val"><span id="ePi">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">
              <span class="tipwrap">Credibility
                <span class="tip" tabindex="0" data-tip="Credibility is a 0–100 trust index.

It falls when:
• You talk hawkish but cut rates (or talk dovish but hike).
• You swing policy wildly.
• You keep missing targets badly.

It rises slowly when your words match actions and you stabilize inflation and unemployment.

High credibility makes guidance move expectations more."></span>
              </span>
            </div>
            <div class="val"><span id="cred">—</span> / 100</div>
            <div class="meter"><span id="credBar"></span></div>
          </div>
        </div>

        <div class="twoCol">
          <div class="card" style="background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.08)">
            <div class="pad">
              <h2>Inflation & Unemployment</h2>
              <canvas id="chart1" width="840" height="420"></canvas>
            </div>
          </div>
          <div class="card" style="background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.08)">
            <div class="pad">
              <h2>Policy & Output gap</h2>
              <canvas id="chart2" width="840" height="420"></canvas>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h2 style="font-size:14px;margin:10px 0">Student submission text (auto-generated)</h2>
          <div class="small">Paste this into Canvas as your submission, or use it as a reflection starter.</div>
          <textarea id="summary" readonly></textarea>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  const TARGET_PI = 2.0;
  const NAIRU = 4.5;
  const QMAX = 12;

  const params = {
    rStar: 0.75,
    yPersist: 0.72,
    yRateSens: 0.55,
    yQeSens: 0.18,
    yShockSd: 0.55,

    piPersist: 0.55,
    piExpectWeight: 0.35,
    piSlope: 0.22,
    piShockSd: 0.35,

    uPersist: 0.75,
    okun: 0.35,
    uShockSd: 0.12,

    expAnchoring: 0.70,
    expAdapt: 0.22,
    expGuidance: 0.18,

    movePenalty: 5.0,
    volPenalty: 2.0,
  };

  let t = 1;
  let score = 0;
  let history;
  let lastPolicy = { i: 2.5, qe: 0, fg: 0 };
  let rngSeed = Math.floor(Math.random()*1e9);
  let pendingShock = null;

  function rand(){
    rngSeed = (1664525*rngSeed + 1013904223) % 4294967296;
    return rngSeed / 4294967296;
  }
  function randn(){
    let u = Math.max(1e-9, rand());
    let v = Math.max(1e-9, rand());
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }
  function clamp(x,a,b){return Math.min(b,Math.max(a,x));}

  // UI
  const qtrEl = document.getElementById('qtr');
  const qtrMaxEl = document.getElementById('qtrMax');
  const scoreEl = document.getElementById('score');
  const scoreMaxEl = document.getElementById('scoreMax');
  const scorePctEl = document.getElementById('scorePct');
  const gradeEl = document.getElementById('grade');

  const iEl = document.getElementById('iRate');
  const qeEl = document.getElementById('qe');
  const fgEl = document.getElementById('fg');
  const iTag = document.getElementById('iTag');
  const qeTag = document.getElementById('qeTag');
  const fgTag = document.getElementById('fgTag');

  const piEl = document.getElementById('pi');
  const uEl = document.getElementById('u');
  const yEl = document.getElementById('y');
  const ePiEl = document.getElementById('ePi');

  const credEl = document.getElementById('cred');
  const credBarEl = document.getElementById('credBar');

  const headlineEl = document.getElementById('headline');
  const newsDeckEl = document.getElementById('newsDeck');
  const policyHintEl = document.getElementById('policyHint');

  const difficultyEl = document.getElementById('difficulty');
  const hintToggleEl = document.getElementById('hintToggle');

  const logEl = document.getElementById('log');
  const summaryEl = document.getElementById('summary');

  const advanceBtn = document.getElementById('advance');
  const resetBtn = document.getElementById('reset');
  const copyBtn = document.getElementById('copy');

  const c1 = document.getElementById('chart1');
  const c2 = document.getElementById('chart2');
  const g1 = c1.getContext('2d');
  const g2 = c2.getContext('2d');

  function fgLabel(v){
    if(v<=-2) return 'Very dovish';
    if(v===-1) return 'Dovish';
    if(v===0) return 'Neutral';
    if(v===1) return 'Hawkish';
    return 'Very hawkish';
  }

  function pushLog(html){
    const p = document.createElement('div');
    p.innerHTML = html;
    logEl.prepend(p);
  }

  function updateTags(){
    const i = parseFloat(iEl.value);
    const qe = parseFloat(qeEl.value);
    const fg = parseInt(fgEl.value,10);

    iTag.textContent = i.toFixed(2) + '%';
    qeTag.textContent = qe.toFixed(2);
    fgTag.textContent = fgLabel(fg);
  }

  function current(){
    const idx = history.pi.length - 1;
    return {
      i: history.i[idx], qe: history.qe[idx], fg: history.fg[idx],
      y: history.y[idx], u: history.u[idx], pi: history.pi[idx], ePi: history.ePi[idx],
      cred: history.cred[idx]
    };
  }

  // Shocks
  function shockEvent(){
    const r = rand();
    if(r < 0.18) return { name:'Oil price spike', type:'cost', pi:+0.6, y:-0.4 };
    if(r < 0.34) return { name:'Demand boom (consumer spending)', type:'demand', pi:+0.3, y:+0.7 };
    if(r < 0.48) return { name:'Credit crunch', type:'demand', pi:-0.2, y:-0.8 };
    if(r < 0.62) return { name:'Productivity jump', type:'supply', pi:-0.3, y:+0.5 };
    if(r < 0.74) return { name:'Housing slowdown', type:'demand', pi:-0.1, y:-0.6 };
    if(r < 0.86) return { name:'Wage push', type:'cost', pi:+0.5, y:-0.2 };
    return { name:'Global growth slowdown', type:'demand', pi:-0.2, y:-0.5 };
  }

  function shockNewsVariants(s){
    // Each shock has an obvious version and an interpretive version.
    // Easy mode will always show the obvious one. Hard mode will always show interpretive.
    // Mixed mode randomly chooses per quarter.

    const variants = {
      'Oil price spike': {
        easy: {
          h:'Energy markets jump as oil prices spike (Cost shock)',
          d:'Input costs rise. Inflation risk increases even if growth cools.'
        },
        hard: {
          h:'Energy shock ripples through supply chains',
          d:'Price pressure can show up without a demand boom. Tradeoffs ahead.'
        }
      },
      'Demand boom (consumer spending)': {
        easy: {
          h:'Retail sales pop, demand runs hot (Demand shock)',
          d:'Stronger demand can raise inflation unless policy cools things off.'
        },
        hard: {
          h:'Households splurge and firms struggle to keep up',
          d:'When the economy overheats, prices tend to follow.'
        }
      },
      'Credit crunch': {
        easy: {
          h:'Banks tighten lending, credit crunch forms (Demand shock)',
          d:'Demand may weaken. Unemployment risk rises. Easier conditions can cushion the hit.'
        },
        hard: {
          h:'Lenders pull back as risk appetite fades',
          d:'Financial conditions do some tightening for you. Watch jobs and growth.'
        }
      },
      'Productivity jump': {
        easy: {
          h:'Productivity surprise boosts output (Supply shock)',
          d:'Better supply can ease inflation pressure while supporting growth.'
        },
        hard: {
          h:'Firms find ways to do more with less',
          d:'The economy may expand without the same price pressure.'
        }
      },
      'Housing slowdown': {
        easy: {
          h:'Housing starts slide, rates bite (Demand shock)',
          d:'Interest sensitive sectors weaken. Too much tightening can overshoot.'
        },
        hard: {
          h:'Construction cools and real estate chatter turns cautious',
          d:'A key engine is slowing. Policy lags can make this tricky.'
        }
      },
      'Wage push': {
        easy: {
          h:'Wage growth accelerates, labor costs climb (Cost shock)',
          d:'Cost pressure can lift inflation even without booming demand.'
        },
        hard: {
          h:'Pay gains surge as firms compete for workers',
          d:'If costs rise faster than productivity, prices can creep up.'
        }
      },
      'Global growth slowdown': {
        easy: {
          h:'Global growth slows, exports soften (Demand shock)',
          d:'External demand weakens. Downside risks rise, inflation may ease.'
        },
        hard: {
          h:'Overseas weakness drags on domestic momentum',
          d:'A softer world economy can cool things at home too.'
        }
      },
    };

    return variants[s.name] || {
      easy:{h:'Breaking: Mixed data (Unclear shock)', d:'Uncertain outlook. Choose policy carefully.'},
      hard:{h:'Crosscurrents dominate the outlook', d:'Signals are noisy. Prioritize targets and avoid thrashing.'}
    };
  }

  function chooseDifficultyVariant(){
    const mode = difficultyEl.value;
    if(mode === 'easy') return 'easy';
    if(mode === 'hard') return 'hard';
    // Mixed
    return (rand() < 0.5) ? 'easy' : 'hard';
  }

  function buildPolicyHint(s, prev){
    // This is guidance, not a rule. It uses the shock type plus where the economy is vs targets.

    const piGap = prev.pi - TARGET_PI;
    const uGap = prev.u - NAIRU;

    // Determine which target is currently more off.
    const priority = (Math.abs(piGap) > Math.abs(uGap)) ? 'inflation' : 'jobs';

    // Base rec: shock type
    let base = '';
    if(s.type === 'cost'){
      base = 'This looks like cost push inflation risk. If inflation is above target, consider modest tightening (higher i, QT, or hawkish guidance). If unemployment is rising fast, go slower and prioritize stability.';
    }else if(s.type === 'supply'){
      base = 'This looks like a supply improvement. Inflation pressure may ease. If unemployment is high, you might not need to tighten. Small moves and steady messaging can work.';
    }else{
      // demand
      if(s.y >= 0){
        base = 'This looks demand driven and could run hot. Consider leaning tighter (higher i, QT, or hawkish guidance) to prevent overheating.';
      }else{
        base = 'This looks like demand weakness. Consider leaning easier (lower i, QE, or dovish guidance) to support jobs and output.';
      }
    }

    // Add a "check yourself" line based on gaps
    let check = '';
    if(priority === 'inflation'){
      if(piGap > 0.3) check = 'Right now inflation is above target. Be careful about easing too much.';
      else if(piGap < -0.3) check = 'Right now inflation is below target. Tightening may not be necessary.';
      else check = 'Inflation is near target. Avoid huge swings unless unemployment is way off.';
    }else{
      if(uGap > 0.4) check = 'Unemployment is above NAIRU. Over tightening could worsen jobs.';
      else if(uGap < -0.4) check = 'Unemployment is below NAIRU. Demand might be strong, inflation risks could build.';
      else check = 'Unemployment is near NAIRU. Smooth policy can reduce volatility penalties.';
    }

    // Credibility note
    const credNote = (prev.cred < 40)
      ? 'Credibility is low. If you use guidance, match it with your rate move or it will not stick.'
      : (prev.cred > 75)
        ? 'Credibility is high. Guidance will move expectations more, use it carefully.'
        : 'Credibility is moderate. Try to keep words and actions aligned.';

    return `<b>Policy hint:</b> ${base}<br/><b>Check:</b> ${check}<br/><b>Credibility:</b> ${credNote}`;
  }

  function setNewsForQuarter(){
    if(!pendingShock) pendingShock = shockEvent();

    const prev = current();
    const variant = chooseDifficultyVariant();
    const v = shockNewsVariants(pendingShock)[variant];

    headlineEl.textContent = `Breaking (Q${Math.min(t,QMAX)}): ${v.h}`;
    newsDeckEl.textContent = v.d;

    if(hintToggleEl.checked){
      policyHintEl.style.display = 'block';
      policyHintEl.innerHTML = buildPolicyHint(pendingShock, prev);
    }else{
      policyHintEl.style.display = 'none';
      policyHintEl.innerHTML = '';
    }
  }

  // Credibility
  function credibilityDelta(i, qe, fg, prevI, prevQE, prev){
    const di = i - prevI;
    const dqe = qe - prevQE;

    let mismatch = 0;
    if (fg >= 1 && di < -0.10) mismatch += 10;
    if (fg <= -1 && di > 0.10) mismatch += 10;

    mismatch += Math.max(0, (Math.abs(di)*8 - 2));
    mismatch += Math.max(0, (Math.abs(dqe)*3 - 1));

    mismatch += Math.max(0, (Math.abs(prev.pi - TARGET_PI) - 0.6) * 2.0);
    mismatch += Math.max(0, (Math.abs(prev.u - NAIRU) - 0.8) * 1.4);

    let bonus = 0;
    if (fg >= 1 && di > 0.10) bonus += 4;
    if (fg <= -1 && di < -0.10) bonus += 4;
    if (Math.abs(di) <= 0.25 && Math.abs(dqe) <= 0.25) bonus += 1.5;

    return clamp(bonus - mismatch, -18, +10);
  }

  // Grade
  function gradeFromScore(totalScore){
    const quartersCompleted = Math.min(QMAX, Math.max(1, history.pi.length - 1));
    const maxSoFar = quartersCompleted * 120;
    const pct = (totalScore / maxSoFar) * 100;
    if(pct >= 78) return {g:'Fed Whisperer', c:'var(--good)'};
    if(pct >= 65) return {g:'Solid Hawk/Dove', c:'var(--good)'};
    if(pct >= 52) return {g:'Mixed Signals', c:'var(--warn)'};
    return {g:'Oops, Recession', c:'var(--bad)'};
  }

  function updateDashboard(){
    const cur = current();
    qtrEl.textContent = Math.min(t, QMAX);

    const quartersCompleted = Math.min(QMAX, Math.max(1, history.pi.length - 1));
    const maxSoFar = quartersCompleted * 120;

    scoreEl.textContent = score.toFixed(0);
    scoreMaxEl.textContent = maxSoFar.toFixed(0);
    scorePctEl.textContent = ((score / maxSoFar) * 100).toFixed(0) + '%';

    const gr = gradeFromScore(score);
    gradeEl.textContent = gr.g;
    gradeEl.style.borderColor = 'rgba(255,255,255,.14)';
    gradeEl.style.color = gr.c;

    piEl.textContent = cur.pi.toFixed(2);
    uEl.textContent = cur.u.toFixed(2);
    yEl.textContent = cur.y.toFixed(2);
    ePiEl.textContent = cur.ePi.toFixed(2);

    credEl.textContent = cur.cred.toFixed(0);
    credBarEl.style.width = cur.cred.toFixed(0) + '%';
  }

  function updateButtons(){
    advanceBtn.disabled = (t > QMAX);
    if(t > QMAX){
      pushLog(`<b>Run complete.</b> Final score: ${score.toFixed(0)} (${gradeFromScore(score).g}). Reset and try smaller moves, and keep message and action consistent.`);
    }
  }

  function updateSummary(){
    const n = history.pi.length - 1;
    const lines = [];
    lines.push(`Fed Game Plus - Run Summary`);
    lines.push(`Quarters played: ${Math.min(n, QMAX)}`);
    lines.push(`Final score: ${score.toFixed(0)} (${gradeFromScore(score).g})`);
    lines.push(`Targets: inflation 2.0%, unemployment 4.5%`);
    lines.push('');

    const cur = current();
    lines.push(`End-of-run readings: π=${cur.pi.toFixed(2)}%, u=${cur.u.toFixed(2)}%, y=${cur.y.toFixed(2)}%, Eπ=${cur.ePi.toFixed(2)}%, Credibility=${cur.cred.toFixed(0)}/100`);
    lines.push('');

    lines.push('Quarter-by-quarter decisions and shocks:');
    for(let q=1;q<=Math.min(QMAX,n);q++){
      lines.push(
        `Q${q}: Shock=${history.shocks[q]}; i=${history.i[q].toFixed(2)}%; QE=${history.qe[q].toFixed(2)}; FG=${fgLabel(history.fg[q])}; `+
        `π=${history.pi[q].toFixed(2)}%; u=${history.u[q].toFixed(2)}%; y=${history.y[q].toFixed(2)}%; Cred=${history.cred[q].toFixed(0)}/100`
      );
    }

    lines.push('');
    lines.push('Reflection prompts (answer in 3–6 sentences):');
    lines.push('1) Which headline mattered most, and what did it signal about inflation vs unemployment tradeoffs?');
    lines.push('2) Did the policy hint help or mislead you? Use one quarter as evidence.');
    lines.push('3) Where did your guidance match your rate move, and what happened to credibility?');

    summaryEl.value = lines.join('\n');

  }

  // Charts
  function drawAxes(ctx, w, h, pad, yMin, yMax, xMax, yLabel){
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle = 'rgba(255,255,255,.18)';
    ctx.lineWidth = 1;
    ctx.strokeRect(pad, pad, w-2*pad, h-2*pad);

    ctx.fillStyle = 'rgba(255,255,255,.72)';
    ctx.font = '12px system-ui';
    ctx.fillText(yLabel, pad, pad-8);

    const gridN = 5;
    ctx.strokeStyle = 'rgba(255,255,255,.08)';
    for(let i=0;i<=gridN;i++){
      const y = pad + (h-2*pad)*(i/gridN);
      ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
      const val = (yMax - (yMax-yMin)*(i/gridN));
      ctx.fillStyle = 'rgba(255,255,255,.5)';
      ctx.fillText(val.toFixed(1), 6, y+4);
    }

    for(let q=1;q<=xMax;q++){
      const x = pad + (w-2*pad)*((q-1)/(Math.max(1,xMax-1)));
      ctx.fillStyle = 'rgba(255,255,255,.45)';
      ctx.fillText('Q'+q, x-10, h-pad+18);
    }

    return {
      xFromQ:(q)=> pad + (w-2*pad)*((q-1)/(Math.max(1,xMax-1))),
      yFromV:(v)=> pad + (h-2*pad)*(1-(v-yMin)/(yMax-yMin))
    };
  }

  function plotLine(ctx, map, series, color){
    ctx.strokeStyle = color;
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    for(let q=1;q<series.length;q++){
      const x = map.xFromQ(q);
      const y = map.yFromV(series[q]);
      if(q===1) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function plotTarget(ctx, map, target, color, label){
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(map.xFromQ(1), map.yFromV(target));
    ctx.lineTo(map.xFromQ(Math.max(1, history.pi.length-1)), map.yFromV(target));
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = color;
    ctx.font = '12px system-ui';
    ctx.fillText(label, map.xFromQ(1)+6, map.yFromV(target)-6);
  }

  function redraw(){
    const n = Math.min(QMAX, history.pi.length-1);
    const pad=46;

    const w1=c1.width, h1=c1.height;
    const piMin=-1, piMax=8;
    const mapPi = drawAxes(g1, w1, h1, pad, piMin, piMax, n, 'π (Inflation, %)');
    plotTarget(g1, mapPi, TARGET_PI, 'rgba(255,209,102,.9)', 'Target 2.0');
    plotLine(g1, mapPi, history.pi.slice(0,n+1), 'rgba(255,92,122,.95)');

    const uMin=2.5, uMax=10;
    const mapU = {xFromQ: mapPi.xFromQ, yFromV:(v)=> pad + (h1-2*pad)*(1-(v-uMin)/(uMax-uMin))};
    plotTarget(g1, mapU, NAIRU, 'rgba(53,208,127,.85)', 'NAIRU 4.5');
    plotLine(g1, mapU, history.u.slice(0,n+1), 'rgba(53,208,127,.95)');

    g1.fillStyle='rgba(255,255,255,.75)';
    g1.font='12px system-ui';
    g1.fillText('Inflation', w1-140, pad-10);
    g1.fillStyle='rgba(255,92,122,.95)'; g1.fillRect(w1-200, pad-18, 10, 10);
    g1.fillStyle='rgba(255,255,255,.75)'; g1.fillText('Unemployment', w1-140, pad+10);
    g1.fillStyle='rgba(53,208,127,.95)'; g1.fillRect(w1-200, pad+2, 10, 10);

    const w2=c2.width, h2=c2.height;
    const yMin=-6, yMax=6;
    const mapY = drawAxes(g2, w2, h2, pad, yMin, yMax, n, 'y (Output gap, %)');
    plotLine(g2, mapY, history.y.slice(0,n+1), 'rgba(255,209,102,.95)');

    const iMin=0, iMax=8;
    const mapI = {xFromQ: mapY.xFromQ, yFromV:(v)=> pad + (h2-2*pad)*(1-(v-iMin)/(iMax-iMin))};
    plotLine(g2, mapI, history.i.slice(0,n+1), 'rgba(135,180,255,.95)');

    g2.fillStyle='rgba(255,255,255,.75)';
    g2.font='12px system-ui';
    g2.fillText('Output gap', w2-140, pad-10);
    g2.fillStyle='rgba(255,209,102,.95)'; g2.fillRect(w2-200, pad-18, 10, 10);
    g2.fillStyle='rgba(255,255,255,.75)';
    g2.fillText('Policy rate', w2-140, pad+10);
    g2.fillStyle='rgba(135,180,255,.95)'; g2.fillRect(w2-200, pad+2, 10, 10);
  }

  function step(){
    if(t > QMAX) return;

    const i = parseFloat(iEl.value);
    const qe = parseFloat(qeEl.value);
    const fg = parseInt(fgEl.value,10);

    const s = pendingShock || shockEvent();
    const prev = current();

    // Credibility
    const dCred = credibilityDelta(i, qe, fg, lastPolicy.i, lastPolicy.qe, prev);
    const cred = clamp(prev.cred + dCred, 0, 100);
    const credFactor = clamp(cred/100, 0.15, 1.0);

    // Expectations
    let ePi = params.expAnchoring*TARGET_PI + params.expAdapt*prev.pi + (params.expGuidance*credFactor)*(-0.10*fg);
    ePi = clamp(ePi, -1, 8);

    const rReal = i - ePi;
    const rGap = rReal - params.rStar;

    const yShock = params.yShockSd*randn() + s.y;
    let y = params.yPersist*prev.y - params.yRateSens*rGap + params.yQeSens*qe + yShock;
    y = clamp(y, -6, 6);

    const piShock = params.piShockSd*randn() + s.pi;
    let pi = params.piPersist*prev.pi + params.piExpectWeight*ePi + params.piSlope*y + piShock;
    pi = clamp(pi, -1, 10);

    const uShock = params.uShockSd*randn();
    let u = params.uPersist*prev.u - params.okun*y + uShock;
    u = clamp(u, 2.5, 12);

    // Score
    const missPi = Math.abs(pi - TARGET_PI);
    const missU = Math.abs(u - NAIRU);

    const moveI = Math.abs(i - lastPolicy.i);
    const moveQE = Math.abs(qe - lastPolicy.qe);
    const vol = Math.abs(y - prev.y) + Math.abs(pi - prev.pi);

    const loss = 8*missPi + 6*missU + params.movePenalty*(0.6*moveI + 0.25*moveQE) + params.volPenalty*vol;
    const points = Math.max(0, 120 - loss*10);
    score += points;

    // Save
    history.i.push(i); history.qe.push(qe); history.fg.push(fg);
    history.y.push(y); history.pi.push(pi); history.u.push(u); history.ePi.push(ePi);
    history.cred.push(cred);
    history.shocks.push(s.name);

    lastPolicy = { i, qe, fg };

    // Log the version they saw (using current difficulty setting, but we store shock name anyway)
    const variant = chooseDifficultyVariant();
    const v = shockNewsVariants(s)[variant];

    t += 1;

    pushLog(
      `Quarter ${t-1} results: Headline was <b>${v.h}</b> (shock: <b>${s.name}</b>). `+
      `Set i=${i.toFixed(2)}%, QE=${qe.toFixed(2)}, Guidance=${fgLabel(fg)}. `+
      `Now π=${pi.toFixed(2)}%, u=${u.toFixed(2)}%, y=${y.toFixed(2)}%. Credibility=${cred.toFixed(0)}/100. +${points.toFixed(0)} pts.`
    );

    // Prep next
    pendingShock = (t <= QMAX) ? shockEvent() : null;

    updateDashboard();
    redraw();
    updateSummary();
    updateButtons();
    setNewsForQuarter();
  }

  function reset(){
    t = 1;
    score = 0;

    history = {
      i: [2.5], qe:[0], fg:[0],
      y: [0.0],
      u: [4.6],
      pi: [2.2],
      ePi: [2.1],
      cred: [72],
      shocks: ['Baseline conditions'],
      notes: []
    };

    lastPolicy = { i: 2.5, qe: 0, fg: 0 };

    iEl.value = 2.5;
    qeEl.value = 0;
    fgEl.value = 0;

    qtrMaxEl.textContent = QMAX;
    logEl.innerHTML = '';

    pendingShock = shockEvent();

    updateTags();
    updateDashboard();
    redraw();
    updateSummary();
    updateButtons();
    setNewsForQuarter();

    pushLog('Quarter 1 briefing: <b>Baseline</b>. Inflation slightly above target, labor market near NAIRU. Read the headline for a clue about the next shock.');
  }

  // Events
  iEl.addEventListener('input', updateTags);
  qeEl.addEventListener('input', updateTags);
  fgEl.addEventListener('input', updateTags);

  difficultyEl.addEventListener('change', ()=>{ setNewsForQuarter(); });
  hintToggleEl.addEventListener('change', ()=>{ setNewsForQuarter(); });

  advanceBtn.addEventListener('click', step);
  resetBtn.addEventListener('click', reset);

  copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(summaryEl.value);
      pushLog('<b>Copied.</b> Summary text is now on your clipboard.');
    }catch(e){
      pushLog('Could not auto-copy. You can still select the text and copy manually.');
    }
  });

  // Start
  reset();
</script>
</body>
</html>
