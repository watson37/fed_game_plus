<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fed Game Plus - Policy Simulator</title>
  <style>
    :root{--bg:#0b1020;--card:#111a33;--ink:#eaf0ff;--muted:#a9b6da;--line:#24335d;--good:#35d07f;--warn:#ffd166;--bad:#ff5c7a;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:linear-gradient(180deg,var(--bg),#070a14)}
    header{padding:18px 18px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px 22px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(17,26,51,.88);border:1px solid rgba(255,255,255,.08);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:14px;margin:0 0 10px;color:var(--ink)}
    .card .pad{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{flex:1;min-width:150px;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;background:rgba(0,0,0,.10)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;margin-top:4px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
    label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
    input[type=range]{width:100%}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{appearance:none;border:1px solid rgba(255,255,255,.14);background:#1a2650;color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:650;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    button.primary{background:#2a3c7a;border-color:rgba(255,255,255,.2)}
    button.danger{background:#4a1e2a}
    button:disabled{opacity:.5;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    canvas{width:100%;height:420px;display:block}
    .log{max-height:220px;overflow:auto;border-top:1px solid rgba(255,255,255,.08);padding:10px 14px;color:var(--muted);font-size:12px;line-height:1.35}
    .log b{color:var(--ink)}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){.twoCol{grid-template-columns:1fr}}
    textarea{width:100%;min-height:120px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:var(--ink);padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px}

    .meter{height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;margin-top:8px}
    .meter .fill{height:100%;width:50%;background:rgba(53,208,127,.95)}

    .hint{margin-top:10px}
  </style>
</head>
<body>
<header>
  <h1>Fed Game Plus - Monetary Policy Simulator</h1>
  <p class="sub">You’re the FOMC. Each quarter you set the policy rate, tweak QE or QT, and choose guidance. The economy responds with lags, expectations, and shocks. Try to keep inflation near target and unemployment near NAIRU without whipping the economy around.</p>
</header>

<div class="wrap">
  <div class="grid">

    <div class="card">
      <div class="pad">
        <h2>Controls</h2>

        <div class="row">
          <div class="kpi">
            <div class="label">Quarter</div>
            <div class="val"><span id="qtr">1</span> / <span id="qtrMax">12</span></div>
          </div>
          <div class="kpi">
            <div class="label">Score</div>
            <div class="val"><span id="score">0</span> <span class="tag" id="grade">—</span></div>
          </div>
        </div>

        <label>Policy rate (i) <span class="tag" id="iTag">2.50%</span></label>
        <input id="iRate" type="range" min="0" max="8" step="0.25" value="2.5" />

        <label>QE / QT (balance sheet impulse) <span class="tag" id="qeTag">0</span></label>
        <input id="qe" type="range" min="-3" max="3" step="0.25" value="0" />
        <div class="small">Negative = QT (tightening). Positive = QE (easing). It acts like a small additional push on demand.</div>

        <label>Forward guidance <span class="tag" id="fgTag">Neutral</span></label>
        <input id="fg" type="range" min="-2" max="2" step="1" value="0" />
        <div class="small">Dovish guidance lowers expected future rates. Hawkish does the opposite. This moves expectations right away, but only if credibility is high.</div>

        <div class="btnbar">
          <button class="primary" id="advance">Advance quarter</button>
          <button id="copy">Copy summary text</button>
          <button class="danger" id="reset">Reset run</button>
        </div>

        <div class="hint small">
          <b>Targets:</b> Inflation 2.0%, Unemployment 4.5% (NAIRU).<br/>
          <b>Tip:</b> Big policy moves raise volatility penalties. Small, steady adjustments usually win.
        </div>
      </div>

      <div class="log" id="log"></div>

    </div>

    <div class="card">
      <div class="pad">
        <h2>Dashboard</h2>
        <div class="row" style="margin-bottom:12px">
          <div class="kpi">
            <div class="label">Inflation (π)</div>
            <div class="val"><span id="pi">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Unemployment (u)</div>
            <div class="val"><span id="u">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Output gap (y)</div>
            <div class="val"><span id="y">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Expected inflation (Eπ)</div>
            <div class="val"><span id="ePi">—</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Credibility</div>
            <div class="val"><span id="cred">—</span> / 100</div>
            <div class="meter" aria-label="Credibility meter"><div class="fill" id="credFill"></div></div>
          </div>
        </div>

        <div class="twoCol">
          <div class="card" style="background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.08)">
            <div class="pad">
              <h2>Inflation & Unemployment</h2>
              <canvas id="chart1" width="840" height="420"></canvas>
            </div>
          </div>
          <div class="card" style="background:rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.08)">
            <div class="pad">
              <h2>Policy & Output gap</h2>
              <canvas id="chart2" width="840" height="420"></canvas>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h2 style="font-size:14px;margin:10px 0">Student submission text (auto-generated)</h2>
          <div class="small">Paste this into Canvas as your submission, or use it as a reflection starter.</div>
          <textarea id="summary" readonly></textarea>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  // Fed Game Plus - lightweight macro model
  // Designed for teaching: lags + expectations + shocks + scoring + credibility.

  const TARGET_PI = 2.0;
  const NAIRU = 4.5;
  const QMAX = 12;

  // Model parameters (tweakable)
  const params = {
    // Natural real rate
    rStar: 0.75,

    // IS curve
    yPersist: 0.72,
    yRateSens: 0.55,
    yQeSens: 0.18,
    yShockSd: 0.55,

    // Phillips curve
    piPersist: 0.55,
    piExpectWeight: 0.35,
    piSlope: 0.22,
    piShockSd: 0.35,

    // Okun
    uPersist: 0.75,
    okun: 0.35,
    uShockSd: 0.12,

    // Expectations
    expAnchoring: 0.70,
    expAdapt: 0.22,
    expGuidance: 0.18,

    // Scoring
    movePenalty: 5.0,
    volPenalty: 2.0,
  };

  // State
  let t = 1;
  let score = 0;
  let credibility = 100;
  let history;
  let lastPolicy = { i: 2.5, qe: 0, fg: 0 };
  let rngSeed = Math.floor(Math.random()*1e9);

  function rand(){
    rngSeed = (1664525*rngSeed + 1013904223) % 4294967296;
    return rngSeed / 4294967296;
  }
  function randn(){
    let u = Math.max(1e-9, rand());
    let v = Math.max(1e-9, rand());
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }
  function clamp(x,a,b){return Math.min(b,Math.max(a,x));}

  // UI elements
  const qtrEl = document.getElementById('qtr');
  const qtrMaxEl = document.getElementById('qtrMax');
  const scoreEl = document.getElementById('score');
  const gradeEl = document.getElementById('grade');

  const iEl = document.getElementById('iRate');
  const qeEl = document.getElementById('qe');
  const fgEl = document.getElementById('fg');
  const iTag = document.getElementById('iTag');
  const qeTag = document.getElementById('qeTag');
  const fgTag = document.getElementById('fgTag');

  const piEl = document.getElementById('pi');
  const uEl = document.getElementById('u');
  const yEl = document.getElementById('y');
  const ePiEl = document.getElementById('ePi');

  const credEl = document.getElementById('cred');
  const credFillEl = document.getElementById('credFill');

  const logEl = document.getElementById('log');
  const summaryEl = document.getElementById('summary');

  const advanceBtn = document.getElementById('advance');
  const resetBtn = document.getElementById('reset');
  const copyBtn = document.getElementById('copy');

  const c1 = document.getElementById('chart1');
  const c2 = document.getElementById('chart2');
  const g1 = c1.getContext('2d');
  const g2 = c2.getContext('2d');

  function fgLabel(v){
    if(v<=-2) return 'Very dovish';
    if(v===-1) return 'Dovish';
    if(v===0) return 'Neutral';
    if(v===1) return 'Hawkish';
    return 'Very hawkish';
  }

  function reset(){
    t = 1;
    score = 0;
    credibility = 100;
    history = {
      i: [2.5], qe:[0], fg:[0],
      y: [0.0],
      u: [4.6],
      pi: [2.2],
      ePi: [2.1],
      cred: [100],
      shocks: ['Baseline conditions'],
      notes: []
    };
    lastPolicy = { i: 2.5, qe: 0, fg: 0 };

    iEl.value = 2.5;
    qeEl.value = 0;
    fgEl.value = 0;

    qtrMaxEl.textContent = QMAX;
    logEl.innerHTML = '';
    updateTags();
    updateDashboard();
    redraw();
    updateSummary();
    updateButtons();
    pushLog('Quarter 1 briefing: <b>Baseline</b>. Inflation slightly above target, labor market near NAIRU. Credibility starts high, do not waste it.');
  }

  function updateTags(){
    const i = parseFloat(iEl.value);
    const qe = parseFloat(qeEl.value);
    const fg = parseInt(fgEl.value,10);

    iTag.textContent = i.toFixed(2) + '%';
    qeTag.textContent = qe.toFixed(2);
    fgTag.textContent = fgLabel(fg);
  }

  function current(){
    const idx = history.pi.length - 1;
    return {
      i: history.i[idx], qe: history.qe[idx], fg: history.fg[idx],
      y: history.y[idx], u: history.u[idx], pi: history.pi[idx], ePi: history.ePi[idx],
      cred: history.cred[idx]
    };
  }

  function pushLog(html){
    const p = document.createElement('div');
    p.innerHTML = html;
    logEl.prepend(p);
  }

  function shockEvent(){
    const r = rand();
    if(r < 0.18) return { name:'Oil price spike', type:'cost', pi:+0.6, y:-0.4 };
    if(r < 0.34) return { name:'Demand boom (consumer spending)', type:'demand', pi:+0.3, y:+0.7 };
    if(r < 0.48) return { name:'Credit crunch', type:'demand', pi:-0.2, y:-0.8 };
    if(r < 0.62) return { name:'Productivity jump', type:'supply', pi:-0.3, y:+0.5 };
    if(r < 0.74) return { name:'Housing slowdown', type:'demand', pi:-0.1, y:-0.6 };
    if(r < 0.86) return { name:'Wage push', type:'cost', pi:+0.5, y:-0.2 };
    return { name:'Global growth slowdown', type:'demand', pi:-0.2, y:-0.5 };
  }

  function step(){
    if(t > QMAX) return;

    // Read chosen policy
    const i = parseFloat(iEl.value);
    const qe = parseFloat(qeEl.value);
    const fg = parseInt(fgEl.value,10);

    const s = shockEvent();
    const prev = current();

    // Credibility update (0-100)
    // Drops with big swings, flip-flops, talk vs action mismatch, and repeated misses.
    const moveI = Math.abs(i - lastPolicy.i);
    const moveQE = Math.abs(qe - lastPolicy.qe);

    const prevI = history.i[history.i.length - 1];
    const prevPrevI = history.i.length >= 2 ? history.i[history.i.length - 2] : prevI;
    const lastMove = prevI - prevPrevI;
    const thisMove = i - lastPolicy.i;

    const flipFlop = (Math.sign(lastMove) !== 0 && Math.sign(thisMove) !== 0 && Math.sign(lastMove) !== Math.sign(thisMove));

    // Talk vs action mismatch
    const talkActionMismatch = (fg >= 1 && thisMove < -0.01) || (fg <= -1 && thisMove > 0.01);

    const missPiPrev = Math.abs
